<html>
<head>
  <meta charset="utf-8">
  <title>Pithy Counter Menu Generator</title>
  <script src="html5sortable.min.js"></script>
  <script src="js-yaml.min.js"></script>
  <style>
    body {
	  font-family: "Open Sans", sans-serif;
	}
	
	h1 {
	 font-size: 2em;
	 margin: 10px;
	}
	
	h2 {
	 font-size: 1.5em;
	 margin: 5px;
	}
	
	.blue {
	  color: #005000;
	  font-weight: bold;
	}
	
	.blueborder {
	 margin: 2px;
	 border: solid 1px #005000;
	 padding: 5px;
	}
	
	.frame {
	  margin: 5px;
	  border: 10px solid #AFAFAF;
	  padding: 5px;

	}
  
    .item-base {
	  /*border: 2px solid;*/
	  margin: 5px;
	  padding: 10px;
	  background: #AFAFAF;
	}
	
	.item-container {
	  /*border: 10px solid #BFAFBF;*/
	  margin: 0px;
	}
	
	.item-content {
	  margin-bottom: 2px;
	}
	
    .item, .item-saver {
	  /*border: 1px solid;*/
	  margin-bottom: 10px;
	  padding: 5px;
	  background: #FFFFFF;
	}
	
	h3 {
	  margin: 0px;
	  margin-bottom: 2px;
	  font-size: 1.2em;
	  cursor: move;
	  color: #000080;
	  display: inline;
	}
	
	h3::before {
	  content: "■ ";
	}
	
	.item-saver h3 {
	  cursor: auto;
	}
	
	.small-link {
	  font-size: 0.8em;
	  text-decoration: underline;
	  cursor: pointer;
	}
	
	h6 {
	  margin: 0px;
	  margin-bottom: 2px;
	  font-size: 1em;
	  text-decoration: underline;
	  cursor: pointer;
	}
	
	label {
	  margin: 0px;
	  margin-bottom: 2px;
	  position: relative;
	}

	input, select, textarea {
	  margin: 0px 2px 2px 2px;
	  background: #F0F0FF;
	  border: 1px solid;
	}

	textarea {
	  margin: 0px;
	  margin-bottom: 2px;
	  padding: 2px;
	  width: 100%;
	}

    label .tooltip {
      visibility: hidden;
      background-color: #FFFFE0;
	  border: 2px solid black;
	  color: #000000;
	  font-weight: normal;
	  width: 300px;
      text-align: center;
      padding: 5px;
      position: absolute;
      z-index: 1;
	  bottom: 130%;
      left: 0%;
	}

    label .tooltip::after {
      content: "";
      position: absolute;
      top: 100%; /* At the bottom of the tooltip */
      left: 5%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: black transparent transparent transparent;
    }

    label .tooltip-bottom {
      visibility: hidden;
      background-color: #FFFFE0;
	  border: 2px solid black;
	  width: 300px;
      text-align: center;
      padding: 5px;
      position: absolute;
      z-index: 1;
	  top: 130%;
      left: 0%;
	}

    label .tooltip-bottom::after {
      content: "";
      position: absolute;
      bottom: 100%; /* At the top of the tooltip */
      left: 5%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: transparent transparent black transparent;
    }

    label:hover .tooltip {
	  visibility: visible;
	}

    label:hover .tooltip-bottom {
	  visibility: visible;
	}

    .add-button {
	  background-color: #E0FFE0;
	  border: 1px solid;
	}
 
    .del-button {
	  background-color: #FFE0E0;
	  border: 1px solid;
	}
	
    .create-button {
	  background-color: #D0D0FF;
	  border: 1px solid;
	}
	
	.sortable-placeholder {
	  border: 3px solid;
	  margin: 2px, 0, 2px, 0;
    }	  
  </style>


</head>
<body onload="">
<h1>Menu Configurator for Pithy with screen</h1>
<div class="frame">
<h2>Config load</h2>
Use this section if you want to open a previously generated YAML configuration.<br />
<button onclick="document.getElementById('infile').click();" class="create-button">Select config file</button><input type="file" id="infile" oninput="prepareFile(this)"  style="display: none">
<span id="infile-name"></span><br />
<div style="display: none" id="infile-adv">
<br />
<label><strong>Additional input required</strong></label><br />
These Home Assistant sensor entities were found in the config:
<pre id="load-ha-config-label"></pre>
Please copy all <u>template entities</u> from this list into the box below.<br />
<strong>Use this format (note there are two spaces before entity names):</strong>
<pre style="background: #F0F0F0">
  entity_name:
    value_template: "{{ }}"
  another_entity:
    value_template: "{{ }}"
  ...</pre>
<textarea id="load-ha-config" rows="12"></textarea><br/>
</div>
<button class="create-button" onclick="readFile()" id="load-file" disabled>Load config</button>
</div>
<div class="frame">
<h2>Basic</h2>
<label>Device type:<span class="tooltip-bottom">What kind of device do you have</span></label>
<select id="d-type" onchange="changeDevice(this)">
<option>-- Please choose one --</option>
<option>Screen</option>
<option>Screen Plus</option>
<option>Counter</option>
<option>Screen Plus Legacy</option>
</select>
<label>Unit name:<span class="tooltip-bottom">Name for this particular device, e.g. pithy_screen_bedroom. Must be lower case, no spaces, no symbols apart from udnerscores.</span></label>
<input type="text" id="unit-name" value="pithy_" oninput="updateFriendlyName(this)"><br />
<label>Friendly name:<span class="tooltip-bottom">Any name you like. Will be used to name internal sensors (temperature, humidity, PIR) if installed.</span></label>
<input type="text" id="friendly-name" value="Pithy"><br />
<h6 onclick="showHide(document.getElementById('hw-adv-set'))">Advanced settings</h6>
<div style="display: none" id="hw-adv-set">
<h2>Hardware</h2>
<label>Board platform:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<select id="board-platform">
<option selected>ESP8266</option>
</select>
<label>Board name:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<select id="board-name">
<option selected value="d1_mini">Wemos D1 mini</option>
</select>
<label>PIR pin:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="pir-pin"><br />
<label>Button pin:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="but-pin"><br />
<label>I²C data pin:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="i2cd-pin">
<label>I²C clock pin:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="i2cc-pin"><br />
<label>Encoder pin A:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="enca-pin" value="D5">
<label>Encoder pin B:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="encb-pin" value="D6">
<label>Encoder switch pin:<span class="tooltip-bottom">If you're unsure, leave as is</span></label>
<input type="text" id="encs-pin" value="D7">
</div>
</div>
<div class="frame">
<h2>WiFi</h2>
<label>Your WiFi credentials:<span class="tooltip-bottom">Enter the WiFi credentials to which you want your device to connect to</span></label><br />
<label>WiFi name (SSID):</label> <input type="text" id="wifi-ssid">
<label>Password:<span class="tooltip-bottom">You can use !secret here</span></label> <input type="text" id="wifi-pass"><br />
<label>Fallback WiFi access point credentials:<span class="tooltip-bottom">If connection fails, the device will create its own WiFi hotspot with these credentials</span></label><br />
<label>WiFi name (SSID):</label> <input type="text" id="ap-wifi-ssid" value="pithy">
<label>Password:<span class="tooltip-bottom">You can use !secret here</span></label> <input type="text" id="ap-wifi-pass" value="pithypithy"><br />
<h2>Management</h2>
<label>API password:<span class="tooltip-bottom">This password is used to connect to Home Assistant. You can use !secret here</span></label> <input type="text" id="api-pass" value="pithy"><br />
<label>OTA password:<span class="tooltip-bottom">For over-the-air updates (flashing). You can use !secret here</span></label> <input type="text" id="ota-pass" value="pithy"><br />
</div>
<div>
<input type="hidden" id="direct-children" class="direct-children" value="0"><input type="hidden" id="all-children" class="all-children" value="0">
<div>
<div class="item-base" id="base">
  <div class="item-saver"><h2>Menu</h2></div>
  <div class="item-saver"><h3>Screensaver</h3><br />
	<div class="blueborder">
      <label class="blue">Encoder shortcut<span class="tooltip">Define action to perform when you press the encoder on screensaver screen</span></label><br />
	  <label>Entity to perform action on:<span class="tooltip">Home Assistant entity name. If you want to trigger an automation or a script, put the name here.</span></label><input id="enc-ss-entity" class="entity" type="text" oninput="fillActCode(this.parentElement.getElementsByTagName('select')[0])"><br />
	  <label>What to do:<span class="tooltip">Choose from predefined actions. If you want to create your own, choose custom and click Advanced settings. If you want to modify one of the predefined, first choose the predefined action, then Custom.</span></label>
	  <select id="enc-ss-act" onchange="fillActCode(this, true)">
	  <option>None</option>
	  <option value="0">Custom service call</option>
	  <option value="1">Trigger automation</option>
	  <option value="2">Trigger script</option>
	  <option value="3">Open cover</option>
	  <option value="4">Close cover</option>
	  <option value="5">Media player play/pause</option>
	  <option value="6">Start vacuum</option>
	  <option value="7">Return vacuum to base</option>
	  <option value="8">Pair Zigbee device</option>
	  <option value="9">Restart HomeAssistant</option>
	  </select><br />
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
	  <label>Service data:</label><br /><textarea id="enc-ss-data" class="service-data" rows="6"></textarea><br />
	  </div>
	</div>
	<div class="blueborder">
      <label class="blue">Button shortcut<span class="tooltip">Define action to perform when you press the button on screensaver screen</span></label><br />
	  <label>Entity to perform action on:<span class="tooltip">Home Assistant entity name. If you want to trigger an automation or a script, put the name here.</span></label><input id="but-ss-entity" class="entity" type="text" oninput="fillActCode(this.parentElement.getElementsByTagName('select')[0])"><br />
	  <label>What to do:<span class="tooltip">Choose from predefined actions. If you want to create your own, choose custom and click Advanced settings. If you want to modify one of the predefined, first choose the predefined action, then Custom.</span></label>
	  <select id="but-ss-act" onchange="fillActCode(this, true)">
	  <option>None</option>
	  <option value="0">Custom service call</option>
	  <option value="1">Trigger automation</option>
	  <option value="2">Trigger script</option>
	  <option value="3">Open cover</option>
	  <option value="4">Close cover</option>
	  <option value="5">Media player play/pause</option>
	  <option value="6">Start vacuum</option>
	  <option value="7">Return vacuum to base</option>
	  <option value="8">Pair Zigbee device</option>
	  <option value="9">Restart HomeAssistant</option>
	  </select><br />
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
	  <label>Service data:</label><br /><textarea id="but-ss-data" class="service-data" rows="6"></textarea><br />
	  </div>
	</div>
  </div>
  <div class="item-container"></div>
  <button onclick="addItem(this)" class="add-button">Add new item</button>
</div>
</div>
</div>
<div class="frame">
<button class="create-button" onclick="startCreateMenu(document.getElementById('base').getElementsByClassName('item-container')[0])" class="calc-children">Create config</button>
<button  class="create-button" onclick="download(document.getElementById('unit-name').value+'.yaml', document.getElementById('pithy-config').value)">Download config file</button><br/>
Scroll down for Home Assistant config<br /><br />
<div id="config-out">
<label>Pithy config:</label><br />
<textarea id="pithy-config" rows="40"></textarea><br/>
<label>Home Assistant config:<span class="tooltip-bottom">Put this into your "sensor:" config in HA config file</span></label><br />
<textarea id="ha-config" rows="40"></textarea><br/>
</div>
</div>

<script>
  sortable('.item-container', {
    items: '.item',
	handle: "h3",
	acceptFrom: ".item-container"
  });
  
  var menuItemBase = `
    <h3>Menu item</h3> <span class="small-link" onclick="showHide(this.parentElement.getElementsByClassName('item-content')[0])">Show/hide settings</span><br />
	<label>Label:<span class="tooltip">This is the text that will show on the screen</span></label><input id="label" class="label" type="text">
    <label>Type:<span class="tooltip">What this menu item should do</span></label>
	<select id="type" onchange="fillItemContent(this)">
	  <option>-- Please choose one --</option>
	  <option value="1">Display value</option>
	  <option value="2">Submenu</option>
	  <option value="3">Continuous setting</option>
	  <option value="4">Binary setting</option>
	  <option value="5">Action button</option>
	  <option value="6">Continuous with confirmation</option>
	</select>
	<input type="hidden" id="direct-children" class="direct-children" value="0"><input type="hidden" id="all-children" class="all-children" value="0">
	<div id="item-content" class="item-content">
	</div>
	<button onclick="deleteItem(this)" class="del-button">Delete this item</button>
	`;
 
  var menuItemContainerBase = `
<div class="item-base">
  <div class="item-container"></div>
  <button onclick="addItem(this)" class="add-button">Add new item</button>
</div>
  `;
 
  function showHide(e) {
    if (e.style.display === "none") {
      e.style.display = "block";
    } else {
      e.style.display = "none";
    }
  }

  function changeDevice(e) {
    var i = e.value;
	var e_pir = document.getElementById("pir-pin");
	var e_but = document.getElementById("but-pin");
	var e_i2cd = document.getElementById("i2cd-pin");
	var e_i2cc = document.getElementById("i2cc-pin");
	var e_unit = document.getElementById("unit-name");
	
	switch(i){
	  case "Screen Plus Legacy":
	    e_pir.value = "D0";
		e_but.value = "TX";
		e_i2cd.value = "D1";
		e_i2cc.value = "D2";
		e_unit.value = "pithy_screen_";
		break;
	
	  case "Screen":
	    e_pir.value = "";
		e_but.value = "TX";
		e_i2cd.value = "D4";
		e_i2cc.value = "D3";
		e_unit.value = "pithy_screen_";
		break;
	
	  case "Screen Plus":
	    e_pir.value = "D1";
		e_but.value = "TX";
		e_i2cd.value = "D4";
		e_i2cc.value = "D3";
		e_unit.value = "pithy_screen_";
		break;
	
	  case "Counter":
	    e_pir.value = "D0";
		e_but.value = "D1";
		e_i2cd.value = "D4";
		e_i2cc.value = "D3";
		e_unit.value = "pithy_counter_";
		break;
	}
	updateFriendlyName(document.getElementById("unit-name"));
  }

  function ucFirstAllWords( str )
  {
      var pieces = str.split(" ");
      for ( var i = 0; i < pieces.length; i++ )
      {
          var j = pieces[i].charAt(0).toUpperCase();
          pieces[i] = j + pieces[i].substr(1);
      }
      return pieces.join(" ");
  }

  function updateFriendlyName(e) {
    var s = e.value.replace(/_/g, " ");
	s = ucFirstAllWords(s);
	document.getElementById("friendly-name").value = s;
  }

  var f_menu_values, f_menu_set_rotary;

  var yaml_text, yaml_config, ha_yaml_config;

  function prepareFile(input) {
    let file = input.files[0];

    let reader = new FileReader();

    reader.readAsText(file);
	
    reader.onload = function() {
	  yaml_text = reader.result;
      yaml_config = jsyaml.load(yaml_text);
	  
	  var se = yaml_config.sensor.filter( function(v) {return v.platform == "homeassistant";} );
	  var bse = yaml_config.binary_sensor.filter( function(v) {return v.platform == "homeassistant";} );
	  if(se.length && bse.length) {
	    var s_list = "";
		// read sensors and binary sensors
	    se.forEach( function(v) { if(v.entity_id.startsWith("sensor.")) s_list += v.entity_id + "\n"; } );
	    bse.forEach( function(v) { if(v.entity_id.startsWith("sensor.")) s_list += v.entity_id + "\n"; } );
	    document.getElementById("load-ha-config-label").innerText = s_list;
		// reset textarea for the entities
		document.getElementById("load-ha-config").value = "";
		// show the field to put in HA entities
		document.getElementById("infile-adv").style.display = "block";
	  }
   	  
	  // enable load button
	  document.getElementById("load-file").disabled = false;
	  // show filename
	  document.getElementById("infile-name").innerHTML = file.name;
	  // reset file input so it can read the same file again
	  input.value = null;
	  
	}

  }


  function readFile() {
	  var ye;
	  
      ha_yaml_config = jsyaml.load("sensor:\n" + document.getElementById("load-ha-config").value);
	  
	  // document.getElementById("ha-config").innerHTML = JSON.stringify(ha_yaml_config, null, 2);
	  
	  document.getElementById("base").getElementsByClassName("item-container")[0].innerHTML = "";
	  // document.getElementById("pithy-config").innerHTML = JSON.stringify(yaml_config, null, 2);

	  document.getElementById("unit-name").value = yaml_config.substitutions.unitName;
	  document.getElementById("friendly-name").value = yaml_config.substitutions.friendlyName;

	  document.getElementById("wifi-ssid").value = yaml_config.wifi.ssid;
	  document.getElementById("wifi-pass").value = yaml_config.wifi.password;
	  document.getElementById("ap-wifi-ssid").value = yaml_config.wifi.ap.ssid;
	  document.getElementById("ap-wifi-pass").value = yaml_config.wifi.ap.password;

	  document.getElementById("api-pass").value = yaml_config.api.password;
	  document.getElementById("ota-pass").value = yaml_config.ota.password;

  	  document.getElementById("pir-pin").value = yaml_config.substitutions.pir;
	  document.getElementById("but-pin").value = yaml_config.substitutions.button;
	  document.getElementById("i2cd-pin").value = yaml_config.substitutions.i2cData;
	  document.getElementById("i2cc-pin").value = yaml_config.substitutions.i2cClock;
	  
	  switch(yaml_config.substitutions.pir+yaml_config.substitutions.button+yaml_config.substitutions.i2cData) {
	    case "D0TXD1": document.getElementById("d-type").value = "Screen Plus Legacy"; break;
	    case "TXD4": document.getElementById("d-type").value = "Screen"; break;
	    case "D1TXD4": document.getElementById("d-type").value = "Screen Plus"; break;
	    case "D0D1D4": document.getElementById("d-type").value = "Counter"; break;
	  }
	  
	  // find dial press in "script" array, return it's "then" action object
	  ye = yaml_config.script.find( function(v) {return v.id == "dial_ss_press";} ).then;
	  // convert the object to YAML and put it into data textarea
	  document.getElementById("enc-ss-data").value = jsyaml.dump(ye);
	  document.getElementById("enc-ss-entity").value = ye["homeassistant.service"].data.entity_id ? ye["homeassistant.service"].data.entity_id : "";
	  document.getElementById("enc-ss-act").value = findActValue(ye["homeassistant.service"].service);
	  if(document.getElementById("enc-ss-act").value == "2") document.getElementById("enc-ss-entity").value = ye["homeassistant.service"].service;
	  
	  // same as above for button press
	  ye = yaml_config.script.find( function(v) {return v.id == "button_1_ss_press";} ).then;
	  document.getElementById("but-ss-data").value = jsyaml.dump(ye);
	  document.getElementById("but-ss-entity").value = ye["homeassistant.service"].data.entity_id ? ye["homeassistant.service"].data.entity_id : "";
	  document.getElementById("but-ss-act").value = findActValue(ye["homeassistant.service"].service);
	  if(document.getElementById("but-ss-act").value == "2") document.getElementById("but-ss-entity").value = ye["homeassistant.service"].service;
	  
	  // find "menu labels" in "globals" array, take it's initial value, remove curly brackets and quotes, split into array of elements and convert to number if applicable
	  menu_labels = yaml_config.globals.find( function(v) {return v.id == "menu_labels";} ).initial_value.replace(/\{|\}|\"/g,"").split(",");
	  menu_functions = yaml_config.globals.find( function(v) {return v.id == "menu_functions";} ).initial_value.replace(/\{|\}|\"/g,"").split(",").map(Number);
      menu_child = yaml_config.globals.find( function(v) {return v.id == "menu_child";} ).initial_value.replace(/\{|\}|\"/g,"").split(",").map(Number);
      menu_length = yaml_config.globals.find( function(v) {return v.id == "menu_length";} ).initial_value.replace(/\{|\}|\"/g,"").split(",").map(Number);

      // split lambdas by rows
	  f_menu_values = yaml_config.script.find( function(v) {return v.id == "menu_values";} ).then[0].lambda.split("\n");
      f_menu_set_rotary = yaml_config.script.find( function(v) {return v.id == "menu_set_rotary";} ).then[0].lambda.split("\n");
      // document.getElementById("ha-config").innerHTML = f_menu_values + f_menu_set_rotary;
	  
	  fillMenuFromArrays(1, menu_length[0]-1, document.getElementById("base").getElementsByClassName("item-container")[0]);
	
	  // hide HA entities
	  document.getElementById("infile-adv").style.display = "none";
	  // disable load button
	  document.getElementById("load-file").disabled = true;

	  // refresh sortable
      sortable('.item-container', 'reload');
    
  }

  function fillMenuFromArrays(m_start, m_length, m_element){
    
    for(var i = m_start; i<=(m_start+m_length-1); i++){
      
	  var e = addItemAuto(m_element);
	  e.getElementsByClassName("label")[0].value = menu_labels[i];
	  e.getElementsByTagName("select")[0].value = menu_functions[i] == 7 ? 1 : menu_functions[i];
	  var f = e.getElementsByClassName("item-content")[0];
	  fillItemContent(e.getElementsByTagName("select")[0]);
	  
	  switch(menu_functions[i]){
	    case 1:
		  // regexp to find "case i:" block
		  var r = new RegExp("case\\s*"+i+"\\s*:", "gi");
		  // find the case block
		  var l = f_menu_values.find( function(v) { return this.test(v); }, r );
		  // extract ESPH entity
		  var ee = l.replace(/.*=.*id\(/i , "").replace(/\).*/i , "");
		  // set entity type
		  var he;
		  switch(ee) {
		  case "${unitName}_temperature":
		    he = ee;
			f.getElementsByTagName("select")[0].value = "1";
		    break
		  case "${unitName}_humidity":
		    he = ee;
			f.getElementsByTagName("select")[0].value = "2";
		    break
		  default:	
		    // extract HA entity
		    var esphe = yaml_config.sensor.find( function(v) {return (v.id == ee && v.platform == "homeassistant");} );
			he = esphe.entity_id;
            // ESPH entity
			f.getElementsByClassName("esph-ent")[0].innerHTML = jsyaml.dump(esphe).replace("platform: homeassistant\n","");
            // HA attribute and real entity
	  	    var hes = he.replace("sensor.","");
	        if(ha_yaml_config.sensor && ha_yaml_config.sensor[hes]) {
			  he = ha_yaml_config.sensor[hes].value_template.match(/state_attr\(['"].*?[.].*?['"]/i)[0].replace(/(state_attr\(|'|")/gi, "");
			  var hea = ha_yaml_config.sensor[hes].value_template.replace(/state_attr\(['"].*?[.].*?['"]/i, "").match(/['"].*?['"]/i)[0].replace(/('|")/gi, "");
			  f.getElementsByClassName("attribute")[0].value = hea;
			// fill template entity
			  f.getElementsByClassName("templ-ent")[0].value = hes + "\n  value_template: \"" + ha_yaml_config.sensor[hes].value_template + "\"";
			}
			break;
		  }
		  
		  // entity name
		  f.getElementsByClassName("entity")[0].value = he;
		  // menu value code without the "case :" part
		  f.getElementsByClassName("menu-values")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  // extract factor
		  var rr = l.match(/[*]\s*[\d.]*/gi);
		  //alert(rr);
		  if(rr !== null) f.getElementsByClassName("dfactor")[0].value = rr[0].replace(/[*]\s*/gi, "");
		  
		  break;
		
	    case 7:
		  // regexp to find "case i:" block
		  var r = new RegExp("case\\s*"+i+"\\s*:", "gi");
		  // find the case block
		  var l = f_menu_values.find( function(v) { return this.test(v); }, r );
		  // extract ESPH entity
		  var ee = l.replace(/.*=.*id\(/i , "").replace(/\).*/i , "");
		  // set entity type
		  var he;
		  switch(ee) {
		  case "${unitName}_motion":
		    he = ee;
		    f.getElementsByTagName("select")[0].value = "3";
		    break
		  default:	
		    // extract HA entity
		    var esphe = yaml_config.binary_sensor.find( function(v) {return (v.id == ee && v.platform == "homeassistant");} );
			he = esphe.entity_id;
            // ESPH entity
			f.getElementsByClassName("esph-ent")[0].innerHTML = jsyaml.dump(esphe).replace("platform: homeassistant\n","");
            // HA attribute and real entity
	  	    var hes = he.replace("sensor.","");
	        if(ha_yaml_config.sensor && ha_yaml_config.sensor[hes]) {
			  he = ha_yaml_config.sensor[hes].value_template.match(/state_attr\(['"].*?[.].*?['"]/i)[0].replace(/(state_attr\(|'|")/gi, "");
			  var hea = ha_yaml_config.sensor[hes].value_template.replace(/state_attr\(['"].*?[.].*?['"]/i, "").match(/['"].*?['"]/i)[0].replace(/('|")/gi, "");
			  f.getElementsByClassName("attribute")[0].value = hea;
			// fill template entity
			  f.getElementsByClassName("templ-ent")[0].value = hes + "\n  value_template: \"" + ha_yaml_config.sensor[hes].value_template + "\"";
			}
			break;
		  }
		  
		  // entity name
		  f.getElementsByClassName("entity")[0].value = he;
		  // menu value code without the "case :" part
		  f.getElementsByClassName("menu-values")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  f.getElementsByClassName("is-bin")[0].checked = true;
		  
		  break;
		
	    case 3:
		  // regexp to find "case i:" block
		  var r = new RegExp("case\\s*"+i+"\\s*:", "gi");
		  // find the case block for menu values
		  var l = f_menu_values.find( function(v) { return this.test(v); }, r );
		  // extract ESPH entity
		  var ee = l.replace(/.*=.*id\(/i , "").replace(/\).*/i , "");
          // extract HA entity
		  var esphe = yaml_config.sensor.find( function(v) {return (v.id == ee && v.platform == "homeassistant");} );
		  he = esphe.entity_id;
		  
          // HA attribute and real entity
		  var hes = he.replace("sensor.","");
	      if(ha_yaml_config.sensor && ha_yaml_config.sensor[hes]) {
			he = ha_yaml_config.sensor[hes].value_template.match(/state_attr\(['"].*?[.].*?['"]/i)[0].replace(/(state_attr\(|'|")/gi, "");
			var hea = ha_yaml_config.sensor[hes].value_template.replace(/state_attr\(['"].*?[.].*?['"]/i, "").match(/['"].*?['"]/i)[0].replace(/('|")/gi, "");
			f.getElementsByClassName("attribute")[0].value = hea;
			// fill template entity
			f.getElementsByClassName("templ-ent")[0].value = hes + "\n  value_template: \"" + ha_yaml_config.sensor[hes].value_template + "\"";
		  }
		  
          // ESPH entity
		  f.getElementsByClassName("esph-ent")[0].innerHTML = jsyaml.dump(esphe).replace("platform: homeassistant\n","");
		  
		  // entity name
		  f.getElementsByClassName("entity")[0].value = he;
		  // menu value code without the "case :" part
		  f.getElementsByClassName("menu-values")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  // extract factor
		  var rr = l.match(/[*]\s*[\d.]*/gi);
		  if(rr !== null) f.getElementsByClassName("dfactor")[0].value = rr[0].replace(/[*]\s*/gi, "");
		  
		  // find the rotary block
		  l = f_menu_set_rotary.find( function(v) { return this.test(v); }, r );
		  // rotary code without the "case :" part
		  f.getElementsByClassName("set-rotary")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  
		  // find action script
		  var as = yaml_config.script.find( function(v) {return (v.id == "menu_actions");} ).then;
		  // find by "== i;" block in condition
		  var ar = new RegExp("==\\s*"+i+"\;", "gi");
		  // get the action block
		  var asi = as.find( function(v) { return this.test(v.if.condition.lambda); }, ar ).if.then;
		  // dump into the field
		  f.getElementsByClassName("service-data")[0].innerHTML = jsyaml.dump(asi);
		  
		  // get from value from action script
		  var sfrom = asi["homeassistant.service"].variables.x.match(/[\d.]*(?=\s*\+)/i);
		  var from = 0;
		  if (sfrom) from = Number(sfrom[0]);
		  f.getElementsByClassName("from")[0].value = from;
		  // get step from action script
		  var sstep = asi["homeassistant.service"].variables.x.match(/[*]\s*[\d.]*/i);
		  var step = 1;
		  if(sstep) step = Number(sstep[0].replace("*",""));
		  f.getElementsByClassName("step")[0].value = step;
		  // calculate to value		  
		  var to = Math.round(from + menu_length[i] * step);
		  f.getElementsByClassName("to")[0].value = to;
		  
		  // Fill select
		  var se = f.getElementsByTagName("select")[0];
		  se.value = 0;
          switch(asi["homeassistant.service"].service) {
		  case "climate.set_temperature":
  		    se.value = 1;
		    break;
		
		  case "climate.set_humidity":
  		    se.value = 2;
		    break;
		
		  case "cover.set_cover_position":
  		    se.value = 3;
		    break;
		
		  case "cover.set_cover_tilt":
  		    se.value = 4;
		    break;
		
		  case "humidifier.set_humidity":
  		    se.value = 5;
		    break;
		
		  case "light.turn_on":
  		    if(asi["homeassistant.service"].data_template.brightness !== null) se.value = 6;
  		    if(asi["homeassistant.service"].data_template.color_temp !== null) se.value = 7;
		    break;
		
		  case "media_player.volume_set":
  		    se.value = 8;
		    break;
		  
		  }
		  
		  break;
		
	    case 6:
		  // regexp to find "case i:" block
		  var r = new RegExp("case\\s*"+i+"\\s*:", "gi");
		  // find the case block for menu values
		  var l = f_menu_values.find( function(v) { return this.test(v); }, r );
		  // extract ESPH entity
		  var ee = l.replace(/.*=.*id\(/i , "").replace(/\).*/i , "");
          // extract HA entity
		  var esphe = yaml_config.sensor.find( function(v) {return (v.id == ee && v.platform == "homeassistant");} );
		  he = esphe.entity_id;
		  
          // HA attribute and real entity
		  var hes = he.replace("sensor.","");
	      if(ha_yaml_config.sensor && ha_yaml_config.sensor[hes]) {
			he = ha_yaml_config.sensor[hes].value_template.match(/state_attr\(['"].*?[.].*?['"]/i)[0].replace(/(state_attr\(|'|")/gi, "");
			var hea = ha_yaml_config.sensor[hes].value_template.replace(/state_attr\(['"].*?[.].*?['"]/i, "").match(/['"].*?['"]/i)[0].replace(/('|")/gi, "");
			f.getElementsByClassName("attribute")[0].value = hea;
			// fill template entity
			f.getElementsByClassName("templ-ent")[0].value = hes + "\n  value_template: \"" + ha_yaml_config.sensor[hes].value_template + "\"";
		  }
		  
          // ESPH entity
		  f.getElementsByClassName("esph-ent")[0].innerHTML = jsyaml.dump(esphe).replace("platform: homeassistant\n","");
		  
		  // entity name
		  f.getElementsByClassName("entity")[0].value = he;
		  // menu value code without the "case :" part
		  f.getElementsByClassName("menu-values")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  // extract factor
		  var rr = l.match(/[*]\s*[\d.]*/gi);
		  if(rr !== null) f.getElementsByClassName("dfactor")[0].value = rr[0].replace(/[*]\s*/gi, "");
		  
		  // find the rotary block
		  l = f_menu_set_rotary.find( function(v) { return this.test(v); }, r );
		  // rotary code without the "case :" part
		  f.getElementsByClassName("set-rotary")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  
		  // find action script
		  var as = yaml_config.script.find( function(v) {return (v.id == "menu_actions");} ).then;
		  // find by "== i;" block in condition
		  var ar = new RegExp("==\\s*"+i+"\;", "gi");
		  // get the action block
		  var asi = as.find( function(v) { return this.test(v.if.condition.lambda); }, ar ).if.then;
		  // dump into the field
		  f.getElementsByClassName("service-data")[0].innerHTML = jsyaml.dump(asi);
		  
		  // get from value from action script
		  var sfrom = asi["homeassistant.service"].variables.x.match(/[\d.]*(?=\s*\+)/i);
		  var from = 0;
		  if (sfrom) from = Number(sfrom[0]);
		  f.getElementsByClassName("from")[0].value = from;
		  // get step from action script
		  var sstep = asi["homeassistant.service"].variables.x.match(/[*]\s*[\d.]*/i);
		  var step = 1;
		  if(sstep) step = Number(sstep[0].replace("*",""));
		  f.getElementsByClassName("step")[0].value = step;
		  // calculate to value		  
		  var to = Math.round(from + menu_length[i] * step);
		  f.getElementsByClassName("to")[0].value = to;
		  
		  // Fill select
		  var se = f.getElementsByTagName("select")[0];
		  se.value = 0;
          switch(asi["homeassistant.service"].service) {
		  case "climate.set_temperature":
  		    se.value = 1;
		    break;
		
		  case "climate.set_humidity":
  		    se.value = 2;
		    break;
		
		  case "cover.set_cover_position":
  		    se.value = 3;
		    break;
		
		  case "cover.set_cover_tilt":
  		    se.value = 4;
		    break;
		
		  case "humidifier.set_humidity":
  		    se.value = 5;
		    break;
		
		  case "light.turn_on":
  		    if(asi["homeassistant.service"].data_template.brightness !== null) se.value = 6;
  		    if(asi["homeassistant.service"].data_template.color_temp !== null) se.value = 7;
		    break;
		
		  case "media_player.volume_set":
  		    se.value = 8;
		    break;
		  
		  }
		  
		  break;
		
	    case 4:
		  // regexp to find "case i:" block
		  var r = new RegExp("case\\s*"+i+"\\s*:", "gi");
		  // find the case block for menu values
		  var l = f_menu_values.find( function(v) { return this.test(v); }, r );
		  // extract ESPH entity
		  var ee = l.replace(/.*=.*id\(/i , "").replace(/\).*/i , "");
          // extract HA entity
		  var esphe = yaml_config.binary_sensor.find( function(v) {return (v.id == ee && v.platform == "homeassistant");} );
		  he = esphe.entity_id;
		  
          // HA attribute and real entity
		  var hes = he.replace("sensor.","");
	      if(ha_yaml_config.sensor && ha_yaml_config.sensor[hes]) {
			he = ha_yaml_config.sensor[hes].value_template.match(/state_attr\(['"].*?[.].*?['"]/i)[0].replace(/(state_attr\(|'|")/gi, "");
			var hea = ha_yaml_config.sensor[hes].value_template.replace(/state_attr\(['"].*?[.].*?['"]/i, "").match(/['"].*?['"]/i)[0].replace(/('|")/gi, "");
			f.getElementsByClassName("attribute")[0].value = hea;
			// fill template entity
			f.getElementsByClassName("templ-ent")[0].value = hes + "\n  value_template: \"" + ha_yaml_config.sensor[hes].value_template + "\"";
		  }
		  
          // ESPH entity
		  f.getElementsByClassName("esph-ent")[0].innerHTML = jsyaml.dump(esphe).replace("platform: homeassistant\n","");
		  
		  // entity name
		  f.getElementsByClassName("entity")[0].value = he;
		  // menu value code without the "case :" part
		  f.getElementsByClassName("menu-values")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  // extract factor
		  var rr = l.match(/[*]\s*[\d.]*/gi);
		  if(rr !== null) f.getElementsByClassName("dfactor")[0].value = rr[0].replace(/[*]\s*/gi, "");
		  
		  // find the rotary block
		  l = f_menu_set_rotary.find( function(v) { return this.test(v); }, r );
		  // rotary code without the "case :" part
		  f.getElementsByClassName("set-rotary")[0].innerHTML = l.replace(/\s*case.*?\:\s*/i , "");
		  
		  // find action script
		  var as = yaml_config.script.find( function(v) {return (v.id == "menu_actions");} ).then;
		  // find by "== i;" block in condition
		  var ar = new RegExp("==\\s*"+i+"\;", "gi");
		  // get the action block
		  var asi = as.find( function(v) { return this.test(v.if.condition.lambda); }, ar ).if.then;
		  // dump into the on/off fields
		  f.getElementsByClassName("service-data-on")[0].innerHTML = jsyaml.dump(asi.if.then);
		  f.getElementsByClassName("service-data-off")[0].innerHTML = jsyaml.dump(asi.if.else);
		  
		  // Fill select
		  var se = f.getElementsByTagName("select")[0];
		  se.value = 0;
          switch(asi.if.then["homeassistant.service"].service) {
		  case "automation.turn_on":
  		    se.value = 1;
		    break;
		
		  case "fan.turn_on":
  		    se.value = 2;
		    break;
		
		  case "humidifier.turn_on":
  		    se.value = 3;
		    break;
		
		  case "light.turn_on":
  		    se.value = 4;
		    break;
		
		  case "lock.lock":
  		    se.value = 5;
		    break;
		
		  case "media_player.shuffle_set":
  		    se.value = 6;
		    break;
		
		  case "switch.turn_on":
  		    se.value = 7;
		    break;
		  
		  }
  
		  break;
		  
	    case 5:
		  // find action script
		  var as = yaml_config.script.find( function(v) {return (v.id == "menu_actions");} ).then;
		  // find by "== i;" block in condition
		  var ar = new RegExp("==\\s*"+i+"\;", "gi");
		  // get the action block
		  var asi = as.find( function(v) { return this.test(v.if.condition.lambda); }, ar ).if.then;
		  // dump into the field
		  f.getElementsByClassName("service-data")[0].innerHTML = jsyaml.dump(asi);
		  
		  // Fill select and entity based on action
		  var he = f.getElementsByClassName("entity")[0];
		  var se = f.getElementsByTagName("select")[0];
		  se.value = 0;
          switch(asi["homeassistant.service"].service) {
		  case "automation.trigger":
  		    se.value = 1;
			he.value = asi["homeassistant.service"].data.entity_id;
		    break;
		
		  case "cover.open_cover":
  		    se.value = 3;
			he.value = asi["homeassistant.service"].data.entity_id;
		    break;
		
		  case "cover.close_cover":
  		    se.value = 4;
			he.value = asi["homeassistant.service"].data.entity_id;
		    break;
		
		  case "vacuum.start":
  		    se.value = 5;
			he.value = asi["homeassistant.service"].data.entity_id;
		    break;
		
		  case "media_player.shuffle_set":
  		    se.value = 6;
			he.value = asi["homeassistant.service"].data.entity_id;
		    break;
		
		  case "vacuum.return_to_base":
  		    se.value = 7;
			he.value = asi["homeassistant.service"].data.entity_id;
		    break;
		  
		  case "zha.permit":
  		    se.value = 8;
		    break;
		  
		  case "homeassistant.restart":
  		    se.value = 9;
		    break;
		  
		  default:
		    if(asi["homeassistant.service"].service.startsWith("script.")) {
		      se.value = 2;
			  he.value = asi["homeassistant.service"].service;
			}
		  
		  }
  
		  break;
	
	    case 2:
		  // create submenu
		  c = f.getElementsByClassName("item-container")[0];
		  c.innerHTML = "";
	      fillMenuFromArrays(menu_child[i], menu_length[i], c);
		  break;
		
      }
	}
  
  }

  function findActValue(n) {
    switch(n) {
	  case "automation.trigger": return 1;
	  case "cover.open_cover": return 3;
	  case "cover.close_cover": return 4;  
	  case "media_player.media_play_pause": return 5;  
	  case "vacuum.start": return 6;  
	  case "vacuum.return_to_base": return 7;  
	  case "zha.permit": return 8; 
	  case "homeassistant.restart": return 9;  
	}
	if(n.slice(0,7) == "script.") return 2;
  }
  
  function fillItemContent(e) {
    var o = e.parentElement.getElementsByClassName("item-content")[0];
	e.parentElement.getElementsByTagName("h3")[0].innerText = e.selectedIndex == 0 ? "Menu item" : e.options[e.selectedIndex].text;
	var i = e.value;
	var t = "";
	switch(i) {
	  case "1": t = `<label>Entity to display:<span class="tooltip">Home Assistant entity name</span></label><input id="entity" class="entity" type="text" oninput="fillDispCode(this)">
	  <label>Attribute (leave empty if none):<span class="tooltip">Attribute from Home Assistant entity</span></label><input id="attribute" class="attribute" type="text" oninput="fillDispCode(this)">
	  <input type="checkbox" id="is-bin" class="is-bin" oninput="fillDispCode(this)"><label>Entity is binary<span class="tooltip">Uncheck if entity has range of values, check if it is only on or off</span></label><br />
	  <label>Type of entity:<span class="tooltip">Choose if you want Home Assistant entity or one of the internal ones</span></label>
	  <select onchange="fillDispCode(this, true)">
	  <option value="0">Home Assistant</option>
	  <option value="1">Internal temperature</option>
	  <option value="2">Internal humidity</option>
	  <option value="3">Internal motion</option>
	  </select><br />
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
      <label>Display factor:<span class="tooltip">Number to multiply the HA entity value by. Useful if the range is e.g. 0 - 1 but you want to show it as 0 - 100.</span></label><input id="dfactor" class="dfactor" type="number" oninput="fillDispCode(this)" value="1"><br />
	  <label>Code for menu value display:</label><br /><textarea id="menu-values" class="menu-values" rows="2"></textarea><br />
	  <label>ESPHome entity:</label><br /><textarea id="esph-ent" class="esph-ent" rows="14"></textarea><br />
	  <label>HomeAssistant template entity:</label><br /><textarea id="templ-ent" class="templ-ent" rows="3"></textarea><br />
	  </div>
	  `; break;
	  case "2":
	  t = menuItemContainerBase;
	  break;
	  case "3": t = `
	  <label>Entity to change:<span class="tooltip">Home Assistant entity name</span></label><input id="entity" class="entity" type="text" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0])"><label>Attribute (leave empty if none):<span class="tooltip">Attribute from Home Assistant entity</span></label><input id="attribute" class="attribute" type="text" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0])"><br />
	  <label>What to do on change:<span class="tooltip">Choose from predefined actions. If you want to create your own, choose custom and click Advanced settings. If you want to modify one of the predefined, first choose the predefined action, then Custom.</span></label>
	  <select onchange="fillContCode(this, true)">
	  <option>-- Please choose one --</option>
	  <option value="0">Custom service call</option>
	  <option value="1">Climate temperature</option>
	  <option value="2">Climate humidity</option>
	  <option value="3">Cover position</option>
	  <option value="4">Cover tilt</option>
	  <option value="5">Humidifier humidity</option>
	  <option value="6">Light brightness</option>
	  <option value="7">Light temperature</option>
	  <option value="8">Media player volume</option>
	  </select><br />
	  <label>Range from:<span class="tooltip">Lowest value for this entity or attribute</span></label><input id="from" class="from" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0])" value="0"><label>to:<span class="tooltip">Highest value for this entity or attribute</span></label><input id="to" class="to" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0])" value="100">
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
      <label>Step:<span class="tooltip">On each turn of the dial the entity or attribute value will be incremented by this number</span></label><input id="step" class="step" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0])" value="1"><br />
	  <label>Display factor:<span class="tooltip">Number to multiply the HA entity value by. Useful if the range is e.g. 0 - 1 but you want to show it as 0 - 100.</span></label><input id="dfactor" class="dfactor" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0])" value="1"><br />
	  <label>Service data:</label><br /><textarea id="service-data" class="service-data" rows="7"></textarea><br />
	  <label>Code for menu value display:</label><br /><textarea id="menu-values" class="menu-values" rows="2"></textarea><br />
	  <label>Code to set rotary:</label><br /><textarea id="set-rotary" class="set-rotary" rows="2"></textarea><br />
	  <label>ESPHome entity:</label><br /><textarea id="esph-ent" class="esph-ent" rows="14"></textarea><br />
	  <label>HomeAssistant template entity:</label><br /><textarea id="templ-ent" class="templ-ent" rows="3"></textarea><br />
	  </div>
	  `; break;
	  case "4": t = `
	  <label>Entity to change:<span class="tooltip">Home Assistant entity name</span></label><input id="entity" class="entity" type="text" oninput="fillBinCode(this.parentElement.getElementsByTagName('select')[0])"><label>Attribute (leave empty if none):<span class="tooltip">Attribute from Home Assistant entity</span></label><input id="attribute" class="attribute" type="text" oninput="fillBinCode(this.parentElement.getElementsByTagName('select')[0])"><br />
	  <label>What to do on change:<span class="tooltip">Choose from predefined actions. If you want to create your own, choose custom and click Advanced settings. If you want to modify one of the predefined, first choose the predefined action, then Custom.</span></label>
	  <select onchange="fillBinCode(this, true)">
	  <option>-- Please choose one --</option>
	  <option value="0">Custom service calls</option>
	  <option value="1">Automation on/off</option>
	  <option value="2">Fan on/off</option>
	  <option value="3">Humidifier on/off</option>
	  <option value="4">Light on/off</option>
	  <option value="5">Lock lock/unlock</option>
	  <option value="6">Media player shuffle on/off</option>
	  <option value="7">Switch on/off</option>
	  </select><br />
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
	  <label>Service data for ON:</label><br /><textarea id="service-data-on" class="service-data-on" rows="6"></textarea><br />
	  <label>Service data for OFF:</label><br /><textarea id="service-data-off" class="service-data-off" rows="6"></textarea><br />
	  <label>Code for menu value display:</label><br /><textarea id="menu-values" class="menu-values" rows="2"></textarea><br />
	  <label>Code to set rotary:</label><br /><textarea id="set-rotary" class="set-rotary" rows="2"></textarea><br />
	  <label>ESPHome entity:</label><br /><textarea id="esph-ent" class="esph-ent" rows="14"></textarea><br />
	  <label>HomeAssistant template entity:</label><br /><textarea id="templ-ent" class="templ-ent" rows="3"></textarea><br />
	  </div>
	  `; break;
	  case "5": t = `
	  <label>Entity to perform action on:<span class="tooltip">Home Assistant entity name. If you want to trigger an automation or a script, put the name here.</span></label><input id="entity" class="entity" type="text" oninput="fillActCode(this.parentElement.getElementsByTagName('select')[0])"><br />
	  <label>What to do:<span class="tooltip">Choose from predefined actions. If you want to create your own, choose custom and click Advanced settings. If you want to modify one of the predefined, first choose the predefined action, then Custom.</span></label>
	  <select onchange="fillActCode(this, true)">
	  <option>-- Please choose one --</option>
	  <option value="0">Custom service call</option>
	  <option value="1">Trigger automation</option>
	  <option value="2">Trigger script</option>
	  <option value="3">Open cover</option>
	  <option value="4">Close cover</option>
	  <option value="5">Media player play/pause</option>
	  <option value="6">Start vacuum</option>
	  <option value="7">Return vacuum to base</option>
	  <option value="8">Pair Zigbee device</option>
	  <option value="9">Restart HomeAssistant</option>
	  </select><br />
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
	  <label>Service data:</label><br /><textarea id="service-data" class="service-data" rows="6"></textarea><br />
	  </div>
	  `; break;
	  case "6": t = `
	  <label>Entity to change:<span class="tooltip">Home Assistant entity name</span></label><input id="entity" class="entity" type="text" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0], false, true)"><label>Attribute (leave empty if none):<span class="tooltip">Attribute from Home Assistant entity</span></label><input id="attribute" class="attribute" type="text" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0], false, true)"><br />
	  <label>What to do on change:<span class="tooltip">Choose from predefined actions. If you want to create your own, choose custom and click Advanced settings. If you want to modify one of the predefined, first choose the predefined action, then Custom.</span></label>
	  <select onchange="fillContCode(this, true, true)">
	  <option>-- Please choose one --</option>
	  <option value="0">Custom service call</option>
	  <option value="1">Climate temperature</option>
	  <option value="2">Climate humidity</option>
	  <option value="3">Cover position</option>
	  <option value="4">Cover tilt</option>
	  <option value="5">Humidifier humidity</option>
	  <option value="6">Light brightness</option>
	  <option value="7">Light temperature</option>
	  <option value="8">Media player volume</option>
	  </select><br />
	  <label>Range from:<span class="tooltip">Lowest value for this entity or attribute</span></label><input id="from" class="from" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0], false, true)" value="0"><label>to:<span class="tooltip">Highest value for this entity or attribute</span></label><input id="to" class="to" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0], false, true)" value="100">
	  <h6 onclick="showHide(this.parentElement.getElementsByClassName('adv-set')[0])">Advanced settings</h6>
	  <div style="display: none" class="adv-set">
      <label>Step:<span class="tooltip">On each turn of the dial the entity or attribute value will be incremented by this number</span></label><input id="step" class="step" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0], false, true)" value="1"><br />
	  <label>Display factor:<span class="tooltip">Number to multiply the HA entity value by. Useful if the range is e.g. 0 - 1 but you want to show it as 0 - 100.</span></label><input id="dfactor" class="dfactor" type="number" oninput="fillContCode(this.parentElement.getElementsByTagName('select')[0], false, true)" value="1"><br />
	  <label>Service data:</label><br /><textarea id="service-data" class="service-data" rows="7"></textarea><br />
	  <label>Code for menu value display:</label><br /><textarea id="menu-values" class="menu-values" rows="2"></textarea><br />
	  <label>Code to set rotary:</label><br /><textarea id="set-rotary" class="set-rotary" rows="2"></textarea><br />
	  <label>ESPHome entity:</label><br /><textarea id="esph-ent" class="esph-ent" rows="14"></textarea><br />
	  <label>HomeAssistant template entity:</label><br /><textarea id="templ-ent" class="templ-ent" rows="3"></textarea><br />
	  </div>
	  `; break;
    }
	o.innerHTML = t;
	
	if(i == 2) addItem(e.parentElement.getElementsByClassName("item-base")[0].getElementsByClassName("add-button")[0]);
  }

  function fillDispCode(e, s=false) {
	var e_entity = e.parentElement.getElementsByClassName("entity")[0];
	var entity = e_entity.value;

    var e_menuval = e.parentElement.getElementsByClassName("menu-values")[0];

    var e_esphe = e.parentElement.getElementsByClassName("esph-ent")[0];

    var e_hae = e.parentElement.getElementsByClassName("templ-ent")[0];
	
	var ent_type = e.parentElement.getElementsByTagName("select")[0].value;

	var e_attribute = e.parentElement.getElementsByClassName("attribute")[0];
	var attribute = e_attribute.value;

	var e_dfact = e.parentElement.getElementsByClassName("dfactor")[0];
	var dfact = e_dfact.value;

	var e_isbin = e.parentElement.getElementsByClassName("is-bin")[0];
	var isbin = e_isbin.checked;

	var t_attrib = attribute;
	var t_menuval = "";
	var t_esphe = "";
	var t_hae = "";
	
	var t_ha_name = "";
	var t_esph_name = "";
	
    switch(ent_type){
	
	case "0":
	  if(s) {
	    entity = "";
		e_entity.value = "";
		attribute = "";
		e_attribute.value = "";
	  }
	
      t_esph_name = entity.replace(/\./g, "_") + (t_attrib == "" ? "" : "_" + t_attrib);

      if(t_attrib == "") t_ha_name = entity;
	  else {
	    t_ha_name = "sensor.pithy_" + t_esph_name;
	    t_hae = `pithy_${t_esph_name}:
  value_template: "{{ state_attr('${entity}', '${t_attrib}') }}"`;
	  }

	  t_esphe = `name: "HA sensor ${t_ha_name}"
entity_id: ${t_ha_name}
id: ${t_esph_name}
internal: true
on_value:
  then:
    # Logic to correctly update menu values
    - script.execute: menu_values`

    // for internal entities don't add this. It causes resets of encoder while setting
    if(ent_type == 0) t_esphe +=`
    - if:
        condition:
          lambda: 'return id(menu_set_mode);'
        then:
          - script.execute: menu_set_rotary
    # End of menu values logic`;

	  if(isbin)
	    t_menuval = "id(menu_current_value) = id(" + t_esph_name + ").state ? 1 : 0; break;" ;
	  else
	    t_menuval = "id(menu_current_value) = id(" + t_esph_name + ").state" + (dfact == 1 ? "" : " * " + dfact) + "; break;";
		
	  break;
	  
	case "1":
	  t_menuval = "id(menu_current_value) = id(\${unitName}_temperature).state; break;";
	  e_entity.value = "\${unitName}_temperature";
	  e_attribute.value = "";
	  e_isbin.checked = false;
	  break;
	
	case "2":
	  t_menuval = "id(menu_current_value) = id(\${unitName}_humidity).state; break;";
	  e_entity.value = "\${unitName}_humidity";
	  e_attribute.value = "";
	  e_isbin.checked = false;
	  break;
	
	case "3":
	  t_menuval = "id(menu_current_value) = id(\${unitName}_motion).state ? 1 : 0; break;";
	  e_entity.value = "\${unitName}_motion";
	  e_attribute.value = "";
	  e_isbin.checked = true;
	  break;
	  
	}
	
	e_esphe.value = t_esphe;
	
	e_hae.value = t_hae;
	
	e_menuval.value = t_menuval;
	
  }

  function fillContCode(e, r = false, c = false) {
	var i = e.value;

	var entity = e.parentElement.getElementsByClassName("entity")[0].value;

    var e_serv = e.parentElement.getElementsByClassName("service-data")[0];

    var e_menuval = e.parentElement.getElementsByClassName("menu-values")[0];

    var e_srot = e.parentElement.getElementsByClassName("set-rotary")[0];

    var e_esphe = e.parentElement.getElementsByClassName("esph-ent")[0];

    var e_hae = e.parentElement.getElementsByClassName("templ-ent")[0];

	var e_attribute = e.parentElement.getElementsByClassName("attribute")[0];
	var attribute = e_attribute.value;

	var e_from = e.parentElement.getElementsByClassName("from")[0];
	var from = e_from.value

	var e_to = e.parentElement.getElementsByClassName("to")[0];
	var to = e_to.value;

	var e_step = e.parentElement.getElementsByClassName("step")[0];
	var step = e_step.value;

	var e_dfact = e.parentElement.getElementsByClassName("dfactor")[0];
	var dfact = e_dfact.value;

	var range = to - from;

	var t_attrib = attribute;
	var t_serv = "";
	var t_menuval = "";
	var t_rotary = "";
	var t_esphe = "";
	var t_hae = "";
	
	var tss = "";
	var tsd = "";
	
	var t_ha_name = "";
	var t_esph_name = "";
	
	switch(i) {
	
	  case "0": return;	break;
	
	  case "1":  
	  tss = "climate.set_temperature";
	  tsd = "temperature";
	  t_attrib = "temperature";
	  if(r) from = "";
	  if(r) to = "";
	  if(r) step = "";
	  if(r) dfact = 1;
	  break;
	
	  case "2":
      tss = "climate.set_humidity";
      tsd = "humidity";
	  t_attrib = "humidity";
	  if(r) from = 0;
	  if(r) to = 100;
	  if(r) step = 1;
	  if(r) dfact = 1;
	  break;
	
	  case "3":
      tss = "cover.set_cover_position";
      tsd = "position"; 
	  t_attrib = "current_position";
	  if(r) from = 0;
	  if(r) to = 100;
	  if(r) step = 1;
	  if(r) dfact = 1;
	  break;
	
	  case "4":
      tss = "cover.set_cover_tilt";
      tsd = "tilt";
	  t_attrib = "tilt";
	  if(r) from = 0;
	  if(r) to = 100;
	  if(r) step = 1;
	  if(r) dfact = 1;
	  break;
	
	  case "5":
      tss = "humidifier.set_humidity";
      tsd = "humidity";
	  t_attrib = "humidity";
	  if(r) from = 0;
	  if(r) to = 100;
	  if(r) step = 1;
	  if(r) dfact = 1;
	  break;
	
	  case "6":
      tss = "light.turn_on";
      tsd = "brightness";
	  t_attrib = "brightness";
	  if(r) from = 0;
	  if(r) to = 255;
	  if(r) step = 1;
	  if(r) dfact = 1;
	  break;
	
	  case "7":
      tss ="light.turn_on";
      tsd = "color_temp";
	  t_attrib = "color_temp";
	  if(r) from = "";
	  if(r) to = "";
	  if(r) step = 1;
	  if(r) dfact = 1;
	  break;
	
	  case "8":
      tss ="media_player.volume_set";
      tsd = "volume_level";
	  t_attrib = "volume_level";
	  if(r) from = 0;
	  if(r) to = 1;
	  if(r) step = 0.01;
	  if(r) dfact = 100;
	  break;
	
    }

    t_serv = `homeassistant.service:
  variables:
    x: 'return ` + (from == 0 ? "" : from + " + ") + `id(rotary_dial).state` + (step == 1 ? "" : "*" + step) + `;'
  service: ${tss}
  data_template:
    entity_id: ${entity}
    ${tsd}: '{{ x }}'`;

	t_esph_name = entity.replace(/\./g, "_") + (t_attrib == "" ? "" : "_" + t_attrib);

    if(t_attrib == "") t_ha_name = entity;
	else {
	  t_ha_name = "sensor.pithy_" + t_esph_name;
	  t_hae = `pithy_${t_esph_name}:
  value_template: "{{ state_attr('${entity}', '${t_attrib}') }}"`;
	}

	t_esphe = `name: "HA sensor ${t_ha_name}"
entity_id: ${t_ha_name}
id: ${t_esph_name}
internal: true
on_value:
  then:
    # Logic to correctly update menu values
    - script.execute: menu_values
    - if:
        condition:
          lambda: 'return id(menu_set_mode);'
        then:
          - script.execute: menu_set_rotary
    # End of menu values logic`;

    t_rotary = "id(rotary_dial).set_value(round(" + (step == 1 ? "" : "(") + "id(" + t_esph_name + ").state" + (from == 0 ? "" : " - " + from) + (step == 1 ? "" : ")/" + step) + ")); break;";

    if(c)
	  t_menuval = "id(menu_current_value) = id(menu_set_mode) ? " + (from == 0 ? "" : from + " + ") + "id(rotary_dial).state" + (step == 1 ? "" : "*" + step) + " : id(" + t_esph_name + ").state" + (dfact == 1 ? "" : " * " + dfact) + "; break;";
	else
	  t_menuval = "id(menu_current_value) = id(" + t_esph_name + ").state" + (dfact == 1 ? "" : " * " + dfact) + "; break;";
	
	e_serv.value = t_serv;

	if(!(t_attrib == "")) e_attribute.value = t_attrib;
	
	e_esphe.value = t_esphe;
	
	e_hae.value = t_hae;

	e_from.value = from;

	e_to.value = to;

	e_step.value = step;
	
	e_dfact.value = dfact;
	
	e_srot.value = t_rotary;
	
	e_menuval.value = t_menuval;
	
  }

  function fillBinCode(e, r = false) {
	var i = e.value;

	var entity = e.parentElement.getElementsByClassName("entity")[0].value;

    var e_serv_on = e.parentElement.getElementsByClassName("service-data-on")[0];

    var e_serv_off = e.parentElement.getElementsByClassName("service-data-off")[0];

    var e_menuval = e.parentElement.getElementsByClassName("menu-values")[0];

    var e_srot = e.parentElement.getElementsByClassName("set-rotary")[0];

    var e_esphe = e.parentElement.getElementsByClassName("esph-ent")[0];

    var e_hae = e.parentElement.getElementsByClassName("templ-ent")[0];

	var e_attribute = e.parentElement.getElementsByClassName("attribute")[0];
	var attribute = e_attribute.value;

	var t_attrib = attribute;
	var t_serv_on = "";
	var t_serv_off = "";
	var t_menuval = "";
	var t_rotary = "";
	var t_esphe = "";
	var t_hae = "";
	
	var tsson = "";
	var tssoff = "";
	var tsdon = "";
	var tsdoff = "";
	
	var t_ha_name = "";
	var t_esph_name = "";
	
	switch(i) {
	
	  case "0": return;	break;
	
	  case "1":  
	  tsson = "automation.turn_on";
	  tssoff = "automation.turn_off";
      t_attrib = "";
	  break;
	
	  case "2":  
	  tsson = "fan.turn_on";
	  tssoff = "fan.turn_off";
      t_attrib = "";
	  break;

	  case "3":  
	  tsson = "humidifier.turn_on";
	  tssoff = "humidifier.turn_off";
      t_attrib = "";
	  break;
	
	  case "4":  
	  tsson = "light.turn_on";
	  tssoff = "light.turn_off";
      t_attrib = "";
	  break;
	
	  case "5":  
	  tsson = "lock.lock";
	  tssoff = "lock.unlock";
      t_attrib = "";
	  break;
	
	  case "6":  
	  tsson = "media_player.shuffle_set";
	  tssoff = "media_player.shuffle_set";
      t_attrib = "shuffle";
	  tsdon = "\n    shuffle: true";
	  tsdoff = "\n    shuffle: false";
	  break;
	
	  case "7":  
	  tsson = "switch.turn_on";
	  tssoff = "switch.turn_off";
      t_attrib = "";
	  break;
	
    }

    t_serv_on = `homeassistant.service:
  service: ${tsson}
  data:
    entity_id: ${entity}${tsdon}`;

    t_serv_off = `homeassistant.service:
  service: ${tssoff}
  data:
    entity_id: ${entity}${tsdoff}`;

	t_esph_name = entity.replace(/\./g, "_") + (t_attrib == "" ? "" : "_" + t_attrib);

    if(t_attrib == "") t_ha_name = entity;
	else {
	  t_ha_name = "sensor.pithy_" + t_esph_name;
	  t_hae = `pithy_${t_esph_name}:
  value_template: "{{ state_attr('${entity}', '${t_attrib}') }}"`;
	}

	t_esphe = `name: "HA sensor ${t_ha_name}"
entity_id: ${t_ha_name}
id: ${t_esph_name}
internal: true
on_state:
  then:
    # Logic to correctly update menu values
    - script.execute: menu_values
    - if:
        condition:
          lambda: 'return id(menu_set_mode);'
        then:
          - script.execute: menu_set_rotary
    # End of menu values logic`;

    t_rotary = "id(rotary_dial).set_value(id(" + t_esph_name + ").state ? 1 : 0); break;";

    t_menuval = "id(menu_current_value) = id(" + t_esph_name + ").state ? 1 : 0; break;";
	
	e_serv_on.value = t_serv_on;

	e_serv_off.value = t_serv_off;

	e_attribute.value = t_attrib;
	
	e_esphe.value = t_esphe;
	
	e_hae.value = t_hae;
	
	e_srot.value = t_rotary;
	
	e_menuval.value = t_menuval;
	
  }

  function fillActCode(e, r = false){
	var i = e.value;

	var entity = e.parentElement.getElementsByClassName("entity")[0].value;

    var e_serv = e.parentElement.getElementsByClassName("service-data")[0];

	var t_serv = "";

	var tss = "";
	var tsd = "";
	
	switch(i) {
	
      case "None": e_serv.value = ""; return;

	  case "0": return;	break;
	
	  case "1":  
	  tss = "automation.trigger";
	  tsd = "entity_id: " + entity;
	  break;
	
	  case "2":  
	  tss = entity;
	  tsd = "";
	  break;
	
	  case "3":  
	  tss = "cover.open_cover";
	  tsd = "entity_id: " + entity;
	  break;
	
	  case "4":  
	  tss = "cover.close_cover";
	  tsd = "entity_id: " + entity;
	  break;
	
	  case "5":  
	  tss = "media_player.media_play_pause";
	  tsd = "entity_id: " + entity;
	  break;
	
	  case "6":  
	  tss = "vacuum.start";
	  tsd = "entity_id: " + entity;
	  break;
	
	  case "7":  
	  tss = "vacuum.return_to_base";
	  tsd = "entity_id: " + entity;
	  break;
	
	  case "8":  
	  tss = "zha.permit";
	  tsd = "";
	  break;
	
	  case "9":  
	  tss = "homeassistant.restart";
	  tsd = "";
	  break;
	  
    }

    t_serv = `homeassistant.service:
  service: ${tss}
  data:
    ${tsd}`;

	e_serv.value = t_serv;

  }

  function deleteItem(e) {
    var o = e.parentElement;
	var l = o.parentElement;
	var n = l.getElementsByClassName("item").length;
	if(n > 1) o.remove();
    sortable('.item-container', 'reload');
  }
  
  function addItem(e) {
    var o = e.parentElement.getElementsByClassName("item-container")[0];
	var n = document.createElement("div");
	n.setAttribute("class", "item");
	n.innerHTML = menuItemBase;
	o.appendChild(n);
    sortable('.item-container', 'reload');
  }
  
  function addItemAuto(e) {
	var n = document.createElement("div");
	n.setAttribute("class", "item");
	n.innerHTML = menuItemBase;
	e.appendChild(n);
	return n;
  }

  function download(filename, text) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
  }

  function calcChildren(e) {
    var items = e.children;
	var length = items.length;
	var e_direct = e.parentElement.parentElement.parentElement.getElementsByClassName("direct-children")[0];
	var e_total = e.parentElement.parentElement.parentElement.getElementsByClassName("all-children")[0];
	var total = e_direct.value = length;
	
	for(var i=0; i<length; i++){
	  if(items[i].getElementsByTagName("select")[0].value == 2){
	    // item-content -> item-base -> item-container
	    var e_next = items[i].getElementsByClassName("item-container")[0];
	    total += calcChildren(e_next);
	  }
	}
	
	e_total.value = total;
    return total;
	
  }

  var menu_i = 1;
  var menu_labels = ["Saver"];
  var menu_functions = [0];
  var menu_child = [0];
  var menu_length = [0];

  var menu_values_script = "";
  var menu_rotary_script = "";			
  var menu_actions_script = "";
  
  var ha_entities = "";
  var esph_sensors = "";
  var esph_bin_sensors = "";
  
  var menu_depth = 1;
  var menu_size = 1;
  
  var esph_config = "";
  var ha_config = "";
  
  function startCreateMenu(e) {
    menu_i = 1;
    menu_labels = ["\"Saver\""];
    menu_functions = [0];
    menu_child = [0];
    menu_length = [0];

    menu_values_script = "";
    menu_rotary_script = "";			
    menu_actions_script = "";
	
    ha_entities = `sensor:
  - platform: template
    sensors:\n`;

    esph_sensors = "";
    esph_bin_sensors = "";
	
	menu_depth = 1;
	menu_size = 1;
	
	esph_config = "";
	ha_config = "";

  	menu_size += calcChildren(e);
	
	createMenu(e);
	
	menu_length[0] = 1 + Number(e.parentElement.parentElement.parentElement.getElementsByClassName("direct-children")[0].value);
	
	createConfig();
	
	if(ha_entities == `sensor:
  - platform: template
    sensors:\n`) ha_entities = "";
	
	document.getElementById("pithy-config").innerHTML = esph_config;
	document.getElementById("ha-config").innerHTML = ha_entities;
  }

  function createMenu(e) {
    var items = e.children;
	var length = items.length;
	var nextchild = 0;
	
	var has_submenu = false;
	
	for(var i=0; i<length; i++){

	  menu_labels[menu_i + i] = "\"" + items[i].getElementsByClassName("label")[0].value + "\"";
	  var f = menu_functions[menu_i + i] = items[i].getElementsByTagName("select")[0].value;
	  
      menu_child[menu_i + i] = 0;
	  menu_length[menu_i + i] = 0;
	  
	  switch(f) {
	    case "1":
		  var lines = items[i].getElementsByClassName("menu-values")[0].value.split("\n");
		  for (t of lines) menu_values_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_values_script += "\n";

          if (items[i].getElementsByTagName("select")[0].value == "0") {
		    if(items[i].getElementsByClassName("templ-ent")[0].value != "") {
		      lines = items[i].getElementsByClassName("templ-ent")[0].value.split("\n");
		      for (t of lines) ha_entities += "      " + t + "\n";
		    }

            esph_sensors += "  - platform: homeassistant\n"
		    lines = items[i].getElementsByClassName("esph-ent")[0].value.split("\n");
		    for (t of lines) esph_sensors += "    " + t + "\n";
		    esph_sensors += "\n";
		  }
		  
		  if( items[i].getElementsByClassName("is-bin")[0].checked ) menu_functions[menu_i + i] = 7;
          
		  break;
		  
	    case "2":
		  menu_child[menu_i + i] = menu_i + length + nextchild;
		  menu_length[menu_i + i] = Number(items[i].getElementsByClassName("direct-children")[0].value);
		  nextchild += Number(items[i].getElementsByClassName("all-children")[0].value);
		  
		  has_submenu = true;
		  
		  break;
        
	    case "3":
		  var from = items[i].getElementsByClassName("from")[0].value;
          var to = items[i].getElementsByClassName("to")[0].value;
	      var step = items[i].getElementsByClassName("step")[0].value;

		  menu_length[menu_i + i] = Math.round((to - from)/step);

		  var lines = items[i].getElementsByClassName("menu-values")[0].value.split("\n");
		  for (t of lines) menu_values_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_values_script += "\n";

          lines = items[i].getElementsByClassName("set-rotary")[0].value.split("\n");
		  for (t of lines) menu_rotary_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_rotary_script += "\n";
		  
          menu_actions_script +=`      - if:
          condition:
            lambda: 'return id(menu_current_node) == ` + Number(menu_i + i) + `;'
          then:\n`;
		  lines = items[i].getElementsByClassName("service-data")[0].value.split("\n");
		  for (t of lines) menu_actions_script += "            " + t + "\n";
		  menu_actions_script += "\n";
		  
		  if(items[i].getElementsByClassName("templ-ent")[0].value != "") {
		    lines = items[i].getElementsByClassName("templ-ent")[0].value.split("\n");
		    for (t of lines) ha_entities += "      " + t + "\n";
		  }

          esph_sensors += "  - platform: homeassistant\n"
		  lines = items[i].getElementsByClassName("esph-ent")[0].value.split("\n");
		  for (t of lines) esph_sensors += "    " + t + "\n";
		  esph_sensors += "\n";
          
		  break;

	    case "4":
		  var lines = items[i].getElementsByClassName("menu-values")[0].value.split("\n");
		  for (t of lines) menu_values_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_values_script += "\n";

          lines = items[i].getElementsByClassName("set-rotary")[0].value.split("\n");
		  for (t of lines) menu_rotary_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_rotary_script += "\n";
		  
          menu_actions_script +=`      - if:
          condition:
            lambda: 'return id(menu_current_node) == ` + Number(menu_i + i) + `;'
          then:
            if:
              condition:
                lambda: 'return id(rotary_dial).state;'
              then:\n`;
		  lines = items[i].getElementsByClassName("service-data-on")[0].value.split("\n");
		  for (t of lines) menu_actions_script += "                " + t + "\n";
		  menu_actions_script += "              else:\n";
		  lines = items[i].getElementsByClassName("service-data-off")[0].value.split("\n");
		  for (t of lines) menu_actions_script += "                " + t + "\n";
		  menu_actions_script += "\n";
		  
		  if(items[i].getElementsByClassName("templ-ent")[0].value != "") {
		    lines = items[i].getElementsByClassName("templ-ent")[0].value.split("\n");
		    for (t of lines) ha_entities += "      " + t + "\n";
		  }

          esph_bin_sensors += "  - platform: homeassistant\n"
		  lines = items[i].getElementsByClassName("esph-ent")[0].value.split("\n");
		  for (t of lines) esph_bin_sensors += "    " + t + "\n";
		  esph_bin_sensors += "\n";
          
		  break;

	    case "5":
          menu_actions_script +=`      - if:
          condition:
            lambda: 'return id(menu_current_node) == ` + Number(menu_i + i) + `;'
          then:\n`;
		  lines = items[i].getElementsByClassName("service-data")[0].value.split("\n");
		  for (t of lines) menu_actions_script += "            " + t + "\n";
		  menu_actions_script += "\n";
		  
          break;
		  
	    case "6":
		  var from = items[i].getElementsByClassName("from")[0].value;
          var to = items[i].getElementsByClassName("to")[0].value;
	      var step = items[i].getElementsByClassName("step")[0].value;

		  menu_length[menu_i + i] = Math.round((to - from)/step);

		  var lines = items[i].getElementsByClassName("menu-values")[0].value.split("\n");
		  for (t of lines) menu_values_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_values_script += "\n";

          lines = items[i].getElementsByClassName("set-rotary")[0].value.split("\n");
		  for (t of lines) menu_rotary_script += "            case " + Number(menu_i + i) + ": " + t + "\n";
		  menu_rotary_script += "\n";
		  
          menu_actions_script +=`      - if:
          condition:
            lambda: 'return id(menu_current_node) == ` + Number(menu_i + i) + `;'
          then:\n`;
		  lines = items[i].getElementsByClassName("service-data")[0].value.split("\n");
		  for (t of lines) menu_actions_script += "            " + t + "\n";
		  menu_actions_script += "\n";
		  
		  if(items[i].getElementsByClassName("templ-ent")[0].value != "") {
		    lines = items[i].getElementsByClassName("templ-ent")[0].value.split("\n");
		    for (t of lines) ha_entities += "      " + t + "\n";
		  }

          esph_sensors += "  - platform: homeassistant\n"
		  lines = items[i].getElementsByClassName("esph-ent")[0].value.split("\n");
		  for (t of lines) esph_sensors += "    " + t + "\n";
		  esph_sensors += "\n";
          
		  break;

	  }

	}

    if(has_submenu) menu_depth++;
	
	menu_i += length;

	for(var i=0; i<length; i++){
	  var f = items[i].getElementsByTagName("select")[0].value;

	  if (f == 2){
        var e_next = items[i].getElementsByClassName("item-container")[0];
		createMenu(e_next);
	  }

	}
	
  }
  
  function createConfig() {

  var dial_ss_script = "";
  var button_1_ss_script = "";
  
  if(document.getElementById("enc-ss-act") != "None") {
    var lines = document.getElementById("enc-ss-data").value.split("\n");
    for (t of lines) dial_ss_script += "      " + t + "\n";
  }

  if(document.getElementById("but-ss-act") != "None") {
    var lines = document.getElementById("but-ss-data").value.split("\n");
    for (t of lines) button_1_ss_script += "      " + t + "\n";
  }

  
    esph_config = `### Pithy Screen Menu System for controlling Home Assistant
###
### Created by: Milan Korenica
### Licensed under GNU General Public License v3.0

esphome:
  name: \${unitName}
  platform: \${boardPlatform}
  board: \${boardName}
#set default for rotary
  on_boot:
    priority: 250
    then:
      - sensor.rotary_encoder.set_value:
          id: rotary_dial
          value: 0
      - binary_sensor.template.publish:
          id: api_connected
          state: OFF
      - wait_until:
          api.connected
      - sensor.rotary_encoder.set_value:
          id: rotary_dial
          value: 0
      - binary_sensor.template.publish:
          id: api_connected
          state: ON
          
wifi:
  ssid: ${document.getElementById("wifi-ssid").value}
  password: ${document.getElementById("wifi-pass").value}

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: ${document.getElementById("ap-wifi-ssid").value}
    password: ${document.getElementById("ap-wifi-pass").value}

captive_portal:

# Enable logging
logger:

# Enable Home Assistant API
api:
  password: ${document.getElementById("api-pass").value}

ota:
  password: ${document.getElementById("ota-pass").value}

#####
#####  CONFIGURATION BLOCK HERE
#####
substitutions:
  boardPlatform: ${document.getElementById("board-platform").value}
  boardName: ${document.getElementById("board-name").value}
  unitName: ${document.getElementById("unit-name").value}
  friendlyName: ${document.getElementById("friendly-name").value}
  
  encoderPinA: ${document.getElementById("enca-pin").value}
  encoderPinB: ${document.getElementById("encb-pin").value}
  encoderSwitch: ${document.getElementById("encs-pin").value}
  i2cData: ${document.getElementById("i2cd-pin").value}
  i2cClock: ${document.getElementById("i2cc-pin").value}
  ${document.getElementById("pir-pin").value == "" ? "" : "pir: "+document.getElementById("pir-pin").value}
  button: ${document.getElementById("but-pin").value}
  
  # Menu system
  menuDepth: '${menu_depth}'
  menuSize: '${menu_size}'

#####  END OF CONFIGURATION BLOCK 

globals:
# Screensaver
   - id: ss_x
     type: signed char
     initial_value: '0'

   - id: ss_y
     type: signed char
     initial_value: '8'

   - id: ss_vx
     type: signed char
     initial_value: '1'

   - id: ss_vy
     type: signed char
     initial_value: '1'
     
   - id: wi
     type: unsigned char
     initial_value: '0'
     
# Blank screen
   - id: s_blank
     type: bool
     initial_value: 'false'

# Menu helpers
     
   - id: menu_max_level
     type: unsigned char
     initial_value: '\${menuDepth}'

   - id: menu_level
     type: unsigned char

   - id: menu_position
     type: unsigned char[\${menuDepth}]

   - id: menu_parent
     type: unsigned char[\${menuDepth}]

   - id: menu_current_node
     type: unsigned char

   - id: menu_current_label
     type: char *

   - id: menu_current_value
     type: float

   - id: menu_set_mode
     type: bool
     initial_value: 'false'

#####
#####  CONFIGURATION BLOCK HERE
#####

     # Set these to labels you want to display
   - id: menu_labels
     type: char * [\${menuSize}]
     initial_value: '{${menu_labels}}'

     # Set these to functions of particular menu items
   - id: menu_functions
     type: unsigned char[\${menuSize}]
     initial_value: '{${menu_functions}}'

     # For submenu items, what are the children?
   - id: menu_child
     type: unsigned char[\${menuSize}]
     initial_value: '{${menu_child}}'

     # How many items are there for each submenu? For continuous settings, what is the range?
   - id: menu_length
     type: unsigned char[\${menuSize}]
     initial_value: '{${menu_length}}'

script:
# What value to display for each menu item
  - id: menu_values
    then:
      - lambda: |-
          switch(id(menu_current_node)) {
${menu_values_script}
          }

# What value to set rotary encoder to for each menu item setting
  - id: menu_set_rotary
    then:
      - lambda: |-
          switch(id(menu_current_node)) {
${menu_rotary_script}
          }

# Actions for each menu item setting
  - id: menu_actions
    then:
${menu_actions_script}

# Action when dial is pressed on screensaver screen
  - id: dial_ss_press
    then:
${dial_ss_script}
        
# Action when button is pressed on screensaver screen
  - id: button_1_ss_press
    then:
${button_1_ss_script}

#####  END OF CONFIGURATION BLOCK 

  - id: ss_timeout
    mode: restart
    then:
      - delay: 1min
      - lambda: >-
          id(menu_level) = 0;
          id(menu_position)[0] = 0;
          id(menu_parent)[0] = 0;
          id(menu_current_node) = 0;
          id(menu_set_mode) = false;
          id(rotary_dial).set_value(0);	

${document.getElementById("pir-pin").value == "" ? "" : `  - id: s_blankout
    mode: restart
    then:
      - if:
          condition:
            binary_sensor.is_on: \${unitName}_motion
          then:
            lambda: 'id(s_blank) = false;'
          else:
            - delay: 10s
            - lambda: 'id(s_blank) = true;'
`}
interval:
# Screen saver logic & wait indicator
  - interval: 0.2s
    then:
      - lambda: |-
          id(ss_x) += id(ss_vx);
          id(ss_y) += id(ss_vy);
          if(id(ss_x)>45 || id(ss_x)<1) id(ss_vx) *= -1;
          if(id(ss_y)>29 || id(ss_y)<6) id(ss_vy) *= -1;
          id(wi) = ++id(wi) > 15 ? 0 : id(wi); // wait indicator logic

i2c:
  sda: \${i2cData}
  scl: \${i2cClock}
  frequency: 200kHz
  scan: True
  id: bus_a

time:
  - platform: homeassistant
    id: ha_time
    
font:
  - file: "OpenSans-Regular.ttf"
    id: big_font
    size: 31
    glyphs: ":0123456789"

  - file: "OpenSans-Light.ttf"
    id: small_font
    size: 19
    glyphs: ">-:/&!°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ."

  - file: "OpenSans-Light.ttf"
    id: tiny_font
    size: 12
    glyphs: ":0123456789Conectig."

display:
  - platform: ssd1306_i2c
    model: "SH1106 128x64"
    address: 0x3C
    update_interval: 0.1s
    id: idisplay
    lambda: |-
      if (!id(api_connected).state){

        // Little animation before API is online
        it.line(56, 32, 56+id(wi), 32);

      } else {
    
      // Blank screen if PIR off
      if (id(s_blank)) { it.fill(COLOR_OFF); return; }
      
      // Screensaver is always node 0
      if(id(menu_current_node)==0) {

        // Bouncy time
        it.strftime(id(ss_x), id(ss_y), id(big_font), "%H:%M", id(ha_time).now());
      }
      else {
      
        // Header time
        it.strftime(0, 6, id(tiny_font), COLOR_ON, TextAlign::CENTER_LEFT, "%H:%M", id(ha_time).now());
        // Header wifi
        for(int i=0; i<5; i++) if(i<id(wifistep).state) it.filled_rectangle(102+i*5,8-i*2,4,i*2+4); else it.rectangle(102+i*5,8-i*2,4,i*2+4);
        // Header menu level
        if(id(menu_level)>0){
        
          // y-ccord start of the level display
          int b = 64 - (4 * id(menu_level));
          for(int i=0; i<id(menu_level); i++) {
          
            // Start of this symbol
            int itb = b + i*8;
            // Top line
            it.line(itb, 2, itb+6, 6);
            // Bottom line
            it.line(itb+6, 6, itb, 10);
            
          };
        }
        // Footer menu position
        // y-coord start of the menu pos display
        int b = 64 - (2 * id(menu_length)[id(menu_parent)[id(menu_level)]]);
        for(int i=0; i<id(menu_length)[id(menu_parent)[id(menu_level)]]; i++) {
          
          // Start of this symbol
          int itb = b + i*4;
          if(id(menu_position)[id(menu_level)] == i) it.filled_rectangle(itb, 61, 3, 3);
          else it.draw_pixel_at(itb+1, 62);
            
        };
        
        
        // Show label
        bool s = !id(menu_set_mode) &&
                (id(menu_functions)[id(menu_current_node)] == 2 || 
                 id(menu_functions)[id(menu_current_node)] == 3 || 
                 id(menu_functions)[id(menu_current_node)] == 4 || 
                 id(menu_functions)[id(menu_current_node)] == 6 );
        it.printf(64, 33, id(small_font), TextAlign::TOP_CENTER, "%s%s", id(menu_labels)[id(menu_current_node)], s ? " >" : "" );
        
        // Show value
        if(id(menu_set_mode)) {
          
          switch(id(menu_functions)[id(menu_current_node)]){
          
            case 3:
            case 6:
              // Value
              it.printf(127, 12, id(small_font), TextAlign::TOP_RIGHT, "%.2f", id(menu_current_value));
              // Setting progressbar, outline rectangle
              it.rectangle(0, 20, 54, 12);
              // Inner fill
              it.filled_rectangle(2, 22, round(id(rotary_dial).state*0.50), 8);
              break;
            case 4:
              // Labels
              it.printf(42, 12, id(small_font), TextAlign::TOP_RIGHT, "Off");
              it.printf(86, 12, id(small_font), TextAlign::TOP_LEFT, "On");
              // Switch, outline rectangle
              it.rectangle(52, 20, 24, 12);
              // Inner toggle
              it.filled_rectangle(54 + id(rotary_dial).state*10, 22, 10, 8);

          }

        } else {
        
          // Show value only if Display or Setting
          switch(id(menu_functions)[id(menu_current_node)]){
          
            case 1:
            case 3:
            case 6:
              it.printf(64, 12, id(small_font), TextAlign::TOP_CENTER, "%.2f", id(menu_current_value));
              break;
            case 4:
            case 7:	   
              it.printf(64, 12, id(small_font), TextAlign::TOP_CENTER, "%s", id(menu_current_value) == 0 ? "Off" : "On");
              break;
            case 5: // show button
              it.rectangle(52, 19, 24, 14);
              if(id(rotary_dial_push).state == 0){
                // horizontal shades
                it.line(53, 20, 73, 20);
                it.line(54, 31, 72, 31);
                // vertical shades
                it.line(53, 20, 53, 30);
                it.line(74, 21, 74, 29);

              }
              break;
              
          }
        }
      }
      
      }
          
sensor:
  - platform: rotary_encoder
    id: rotary_dial
    pin_a:
      number: \${encoderPinA}
      inverted: true
      mode: INPUT_PULLUP
    pin_b:
      number: \${encoderPinB}
      inverted: true
      mode: INPUT_PULLUP
    filters:
      - lambda: |-
          unsigned char a;
          if(id(menu_set_mode)) { //if set mode, rotary should go from 0 to according setting

            switch(id(menu_functions)[id(menu_current_node)]){
              case 3: 
              case 6:
                a = id(menu_length)[id(menu_current_node)] + 1; break; // continuous
              case 4: a = 2; break;  // binary
            }

          } else { //if not, it should go to level length

            //get current menu length
            a = id(menu_length)[id(menu_parent)[id(menu_level)]];

          }

          //if rotary is over length, set to length
          if(x >= a) {

            id(rotary_dial).set_value(a-1);
            return a-1;

          }
          else return x;
      - debounce: 0.02s
    resolution: 1
    min_value: 0
    on_value:
      then:
        - if:
            condition:
              api.connected
            then:
              - if:
                  condition:
                    # Are we setting or browsing?
                    lambda: 'return id(menu_set_mode);'
                  then:
                   # Change setting only if not in continuous + confirm
                    - if:
                        condition:
                          lambda: 'return !(id(menu_functions)[id(menu_current_node)] == 6);'
                        then:
                          - script.execute: menu_actions
                  else:
                    # Browsing mode, set menu position
                    - lambda: |-
                        //set current node to start of current child + rotary position
                        id(menu_current_node) = id(menu_child)[id(menu_parent)[id(menu_level)]] + x;
                        //set current level position
                        id(menu_position)[id(menu_level)] = x;
                # Update value
              - script.execute: menu_values
              - script.execute: ss_timeout
  - platform: wifi_signal
    id: wifisignal
    update_interval: 20s
    
  - platform: template
    id: wifistep
    update_interval: 20s
    lambda: |-
      if(isnan(id(wifisignal).state)) return 0;
      else return round((id(wifisignal).state+100)/10);

  - platform: sht3xd
    temperature:
      name: "\${friendlyName} Temperature"
      id: \${unitName}_temperature
      filters:
        - offset: -4
      on_value:
        then:
          # Logic to correctly update menu values
          - script.execute: menu_values
          - if:
              condition:
                lambda: 'return id(menu_set_mode);'
              then:
                - script.execute: menu_set_rotary
          # End of menu values logic
    humidity:
      name: "\${friendlyName} Humidity"
      id: \${unitName}_humidity
      on_value:
        then:
          # Logic to correctly update menu values
          - script.execute: menu_values
          - if:
              condition:
                lambda: 'return id(menu_set_mode);'
              then:
                - script.execute: menu_set_rotary
          # End of menu values logic
    address: 0x44
    update_interval: 15s

#####
#####  CONFIGURATION BLOCK HERE
#####

# Sensors from Home Assistant
${esph_sensors}
#####  END OF CONFIGURATION BLOCK 

binary_sensor:
  - platform: gpio
    id: rotary_dial_push
    pin:
      number: \${encoderSwitch}
      inverted: true
      mode: INPUT_PULLUP
    on_press:
      then:
        - if:
            condition:
              api.connected
            then:
              # Execute screensaver action
              - if:
                  condition: 
                    lambda: 'return id(menu_current_node) == 0;'
                  then:
                    script.execute: dial_ss_press

              - if:
                  condition:
                    # Execute continuous setting with confirmation when returning from set mode
                    lambda: 'return id(menu_functions)[id(menu_current_node)] == 6 && id(menu_set_mode) == true;'
                  then:
                     - script.execute: menu_actions

              - if:
                  condition:
                    # Set mode for continuous or binary setting
                    lambda: 'return (id(menu_functions)[id(menu_current_node)] == 3 || id(menu_functions)[id(menu_current_node)] == 4  || id(menu_functions)[id(menu_current_node)] == 6);'
                  then:
                    - lambda: |-
                        //toggle set mode
                        if(id(menu_set_mode)) {
                        
                          id(menu_set_mode) = false;
                          // restore rotary value to position
                          id(rotary_dial).set_value(id(menu_position)[id(menu_level)]);
      
                        } else id(menu_set_mode) = true;
      
              - if:
                  condition:
                    # Button action
                    lambda: 'return id(menu_functions)[id(menu_current_node)] == 5;'
                  then:
                     - script.execute: menu_actions
      
              # If set mode, set rotary
              - if:
                  condition:
                    lambda: 'return id(menu_set_mode);'
                  then:
                    - script.execute: menu_set_rotary

              - if:
                  condition:
                    # Go to submenu. This needs to be last to prevent setting new item and also executing it
                    lambda: 'return id(menu_functions)[id(menu_current_node)] == 2;'
                  then:
                    - lambda: |-
                        //raise level up to max level
                        id(menu_level) = ++id(menu_level) > id(menu_max_level) ? id(menu_max_level) : id(menu_level);
                        //set parent node for new level
                        id(menu_parent)[id(menu_level)] = id(menu_current_node);
                        //set new current node
                        id(menu_current_node) = id(menu_child)[id(menu_parent)[id(menu_level)]];
                        //reset rotary to 0
                        id(rotary_dial).set_value(0);
                        //reset position in current level to 0
                        id(menu_position)[id(menu_level)] = 0;

              # Display entities value for each menu item
              - script.execute: menu_values
              - script.execute: ss_timeout

${document.getElementById("pir-pin").value == "" ? "" : `  - platform: gpio
    pin: \${pir}
    id: \${unitName}_motion
    name: "\${friendlyName} Motion"
    device_class: motion
    on_state:
      then:
        # Logic to correctly update menu values
        - script.execute: menu_values
        - if:
            condition:
              lambda: 'return id(menu_set_mode);'
            then:
              - script.execute: menu_set_rotary
        # End of menu values logic
        
        # BLank screen if motion not detected
        - script.execute: s_blankout
`}
  - platform: gpio
    id: button_1
    pin:
      number: \${button}
      inverted: true
      mode: INPUT_PULLUP
    on_press:
      then:
        # Execute screensaver action
        - if:
            condition: 
              and:
                - lambda: 'return id(menu_current_node) == 0;'
                - api.connected
            then:
              script.execute: button_1_ss_press
              
        - lambda: |-
            if(id(menu_set_mode)) {
            
              id(menu_set_mode) = false;
              id(rotary_dial).set_value(id(menu_position)[id(menu_level)]);
            }
            else {
            
            if(id(menu_level) > 0) { //if we have anywhere to return
            
              //set new current node to current parent
              id(menu_current_node) = id(menu_parent)[id(menu_level)];
              //return to previous level
              --id(menu_level);
              //reset rotary to position for current level
              id(rotary_dial).set_value(id(menu_position)[id(menu_level)]);
            } else {
            
            if(id(menu_level) == 0) { //if we are at level 0, jump to saver
            
              //set new current node to 0
              id(menu_current_node) = 0;
              //reset rotary to 0
              id(rotary_dial).set_value(0);
              //reset menu position for current level to 0
              id(menu_position)[id(menu_level)] = 0;
            } } }
            
        - script.execute: ss_timeout

  - platform: template
    id: api_connected

#####
#####  CONFIGURATION BLOCK HERE
#####

  # Binary sensors from HomeAssistant
${esph_bin_sensors}
#####  END OF CONFIGURATION BLOCK`
  
  }

  addItem(document.getElementsByClassName('add-button')[0]);
  
</script>
</body>
